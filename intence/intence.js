(function(root,factory){if(typeof define==="function"&&define.amd){define(["exports"],factory)}else if(typeof exports!=="undefined"){factory(exports)}else{factory(root.intence={})}})(this,function(exports){var cfg={textureMaxSqueeze:1e3,indicatorMaxArea:.16,indicatorGain:1/3e3,animationTime:160,animationDelay:20};cfg.blocksNumber=1+Math.ceil(Math.log(cfg.textureMaxSqueeze)/Math.log(4));var UQ="intence-unique-"+(new Date).getTime();var elemSample={div:document.createElement("div"),img:document.createElement("img"),canvas:document.createElement("canvas"),object:document.createElement("object"),style:document.createElement("style")};var checkCSSProperty=function(name,value,params){var idx,camel=name;while((idx=camel.indexOf("-"))!=-1){camel=camel.slice(0,idx)+camel.slice(idx+1,idx+2).toUpperCase()+camel.slice(idx+2)}var elem=elemSample.div.cloneNode(false);var csstext=name+": "+value;if(params){csstext+="("+params+")"}elem.style.cssText=csstext;return camel in document.documentElement.style&&elem.style[camel].indexOf(value)!="-1"};var UA=navigator.userAgent;var IS_FF=typeof InstallTrigger!=="undefined";var IS_IE=false||!!document.documentMode;var IS_SAFARI=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;var IS_CHROME=!!window.chrome;var features={classList:!!elemSample.div.classList,event:!!window.addEventListener,canvas:!!elemSample.canvas.getContext,isolation:checkCSSProperty("isolation","isolate"),opacity:checkCSSProperty("opacity",".5"),transform:checkCSSProperty("transform","translate3d","0, 0, 0"),webkitTransform:checkCSSProperty("-webkit-transform","rotate","-180deg"),backgroundCanvas:{webkit:!!document.getCSSCanvasContext&&checkCSSProperty("background","-webkit-canvas","a"),mozElement:checkCSSProperty("background","-moz-element","#a")},gradientMask:{alphaFilter:checkCSSProperty("filter","progid:DXImageTransform.Microsoft.Alpha","opacity=100,finishOpacity=0,style=1,"+"startX=0,finishX=1,startY=0,finishY=1"),webkit:checkCSSProperty("-webkit-mask-image","-webkit-linear-gradient","top, rgba(0,0,0,1), rgba(0,0,0,0) 100%"),svgReuse:IS_FF}};var IS_IE9=IS_IE&&features.gradientMask.alphaFilter;var INTENCE_ENABLED=true;var METHODS={hasClass:features.classList?"classList":"className",async:features.event?"event":"setTimeout",stackingContext:null,blocks:features.webkitTransform?"webkitTransform":"div",mask:null,canvas:null,floatLeft:null};if(features.canvas){if(features.gradientMask.webkit){METHODS.mask="webkit";METHODS.canvas=features.backgroundCanvas.webkit?"webkit":"dataURL"}else if(features.gradientMask.svgReuse){if(features.backgroundCanvas.mozElement){METHODS.canvas="mozElement";METHODS.mask="svgReuse"}else{METHODS.blocks="svg"}}else if(features.gradientMask.alphaFilter){METHODS.canvas="dataURL";METHODS.mask="alphaFilter";METHODS.blocks="div"}else{METHODS.blocks="svg"}if(features.isolation){METHODS.stackingContext="isolation"}else if(!IS_IE9){if(features.transform){METHODS.stackingContext="transform"}else if(features.opacity){METHODS.stackingContext="opacity"}}}else{INTENCE_ENABLED=false}if(IS_FF&&+UA.match(/Firefox\/(\d+)/)[1]<36){METHODS.floatLeft="stylesheet"}else{METHODS.floatLeft="direct"}if(METHODS.blocks=="svg"&&!IS_IE){INTENCE_ENABLED=false}if(UA.indexOf("Opera")!=-1||IS_FF&&+UA.match(/Firefox\/(\d+)/)[1]<8||IS_CHROME&&+UA.match(/Chrome\/(\d+)/)[1]<15||IS_SAFARI&&+UA.match(/Version\/(\d+)/)[1]<7){INTENCE_ENABLED=false}var impl={};var gradientMask_webkit=function(elem,dir){var where={north:"top",east:"right",south:"bottom",west:"left"};elem.style.WebkitMaskImage="-webkit-linear-gradient("+where[dir]+", "+"rgba(0,0,0,1), rgba(0,0,0,0) 100%)"};var gradientMask_alphaFilter=function(elem,dir){var pos={x1:0,x2:0,y1:0,y2:0};var full={north:"y2",east:"x1",south:"y1",west:"x2"};pos[full[dir]]="100";var filter="progid:DXImageTransform.Microsoft.Alpha("+"opacity=100,"+"finishOpacity=0,"+"style=1,"+"startX="+pos.x1+","+"finishX="+pos.x2+","+"startY="+pos.y1+","+"finishY="+pos.y2+""+")";elem.style.filter=filter};var svgMaskIds={north:null,east:null,south:null,west:null};var gradientMask_svgReuse=function(elem,dir){if(!svgMaskIds[dir]){svgMaskIds[dir]=genMaskSVG(dir)}elem.style.mask="url(#"+svgMaskIds[dir]+")"};var genMaskSVG=function(dir){var id="svg-mask-"+dir+"-"+UQ;var maskId="mask-"+id;var gradientId="gradient-"+id;var svg=util.genSVGElement("svg");var defs=util.genSVGElement("defs",svg);var linearGradient=util.genSVGLinearGradient(defs,dir,gradientId);var mask=util.genSVGElement("mask",defs,{id:maskId,maskUnits:"objectBoundingBox",maskContentUnits:"objectBoundingBox"});var rect=util.genSVGElement("rect",mask,{y:"0",width:"1",height:"1",fill:"url(#"+gradientId+")"});util.setStyle(svg,{position:"absolute",width:"0px",height:"0px"});document.body.appendChild(svg);return maskId};switch(METHODS.mask){case"svgReuse":impl.gradientMask=gradientMask_svgReuse;break;case"webkit":impl.gradientMask=gradientMask_webkit;break;case"alphaFilter":impl.gradientMask=gradientMask_alphaFilter;break}var stackingContext_isolation=function(elem){elem.style.isolation="isolate"};var stackingContext_transform=function(elem){elem.style.transform="translate3d(0,0,0)"};var stackingContext_opacity=function(elem){elem.style.opacity=.9999999};switch(METHODS.stackingContext){case"isolation":impl.stackingContext=stackingContext_isolation;break;case"transform":impl.stackingContext=stackingContext_transform;break;case"opacity":impl.stackingContext=stackingContext_opacity;break;default:impl.stackingContext=function(){};break}var backgroundCanvas_dataURL=function(elem,canvas){elem.style.backgroundImage="url("+util.getCanvasDataURL(canvas)[0]+")"};var canvasCSSCounter=0;var backgroundCanvas_webkit=function(elem,canvas){if(typeof canvas.CSSContextId=="undefined"){var id="canvasCSSContext-"+canvasCSSCounter++ +"-"+UQ;var ctx=document.getCSSCanvasContext("2d",id,canvas.width,canvas.height);ctx.drawImage(canvas,0,0);canvas.CSSContextId=id}elem.style.background="-webkit-canvas("+canvas.CSSContextId+")"};var canvasMozElementCounter=0;var backgroundCanvas_mozElement=function(elem,canvas){if(!canvas.getAttribute("id")){var id="MozElement-"+canvasMozElementCounter++ +"-"+UQ;canvas.setAttribute("id",id);util.setStyle(canvas,{position:"absolute",width:"0px",height:"0px"});document.body.appendChild(canvas)}elem.style.background="-moz-element(#"+canvas.getAttribute("id")+")"};switch(METHODS.canvas){case"dataURL":impl.backgroundCanvas=backgroundCanvas_dataURL;break;case"webkit":impl.backgroundCanvas=backgroundCanvas_webkit;break;case"mozElement":impl.backgroundCanvas=backgroundCanvas_mozElement;break}var async_setTimeout=function(func,obj,args){setTimeout(function(){func.apply(obj||null,args||[])},0)};var async_event=function(func,obj,args){asyncs.push([func,obj||window,args]);window.postMessage(asyncMsg,"*")};var asyncs=[];var asyncMsg="async-"+UQ;var invoke=function(event){if(event.source==window&&event.data==asyncMsg){if(asyncs.length>0){var async=asyncs.shift();async[0].apply(async[1],async[2])}}};if(METHODS.async=="event"){window.addEventListener("message",invoke,true);impl.async=async_event}else{impl.async=async_setTimeout}var hasClass_classList=function(elem,cls){var result=false;var list=elem.classList;for(var i=0;i<list.length;i++){if(list[i]==cls){result=true;break}}return result};var hasClass_className=function(elem,cls){var result=false;var list=elem.className.split(" ");for(var i=0;i<list.length;i++){if(list[i]==cls){result=true;break}}return result};if(METHODS.hasClass=="classList"){impl.hasClass=hasClass_classList}else{impl.hasClass=hasClass_className}var floatLeft_direct=function(elem){elem.style["float"]="left"};var floatLeft_stylesheet=function(elem){elem.className=getFloatLeftClassName()};var _floatLeftClassName=null;var getFloatLeftClassName=function(){if(!_floatLeftClassName){var cls="float-left-cls-"+UQ;var head=document.getElementsByTagName("head")[0];var style=elemSample.style.cloneNode(false);style.type="text/css";style.innerHTML="."+cls+" { float:left; }";head.appendChild(style);_floatLeftClassName=cls}return _floatLeftClassName};if(METHODS.floatLeft=="stylesheet"){impl.floatLeft=floatLeft_stylesheet}else{impl.floatLeft=floatLeft_direct}var util={};util.dir=["north","east","south","west"];util.isVertical={north:true,east:false,south:true,west:false};util.ccv={north:"west",east:"north",south:"east",west:"south"};util.setStyle=function(elem,style){for(var key in style){if(style.hasOwnProperty(key)){elem.style[key]=style[key]}}};util.setAttributes=function(elem,attributes){for(var key in attributes){if(attributes.hasOwnProperty(key)){elem.setAttribute(key,attributes[key])}}};util.px=function(value){return""+value+"px"};util.detachChildren=function(elem){var detached=[];while(elem.firstChild){detached.push(elem.removeChild(elem.firstChild))}return detached};util.attachChildren=function(elem,nodes){for(var i=0;i<nodes.length;i++){elem.appendChild(nodes[i])}};util.getCanvasDataURL=function(canvas){if(typeof canvas.intence_cached_dataURL=="undefined"){canvas.intence_cached_dataURL=[canvas.toDataURL()]}return canvas.intence_cached_dataURL};util.genCanvas=function(w,h){var canvas=elemSample.canvas.cloneNode(false);canvas.width=w;canvas.height=h;util.setStyle(canvas,{width:util.px(w),height:util.px(h),display:"none"});return canvas};util.img2canvas=function(img){var canvas=util.genCanvas(img.width||img.naturalWidth,img.height||img.naturalHeight);var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);return canvas};util._svgNS="http://www.w3.org/2000/svg";util._xlinkNS="http://www.w3.org/1999/xlink";util.genSVGElement=function(name,parent,attrs){var elem=document.createElementNS(util._svgNS,name);if(attrs){for(var key in attrs){if(attrs.hasOwnProperty(key)){if(key.indexOf("xlink")!=-1){elem.setAttributeNS(util._xlinkNS,key,attrs[key])}else{elem.setAttribute(key,attrs[key])}}}}if(parent){parent.appendChild(elem)}return elem};util._commonSVG=null;util.getCommonSVG=function(){if(!util._commonSVGDefs){util._commonSVG=util.genSVGElement("svg",document.body);util.setStyle(util._commonSVG,{width:"0px",height:"0px",position:"absolute",display:"none"})}return util._commonSVG};util._commonSVGDefs=null;util.getCommonSVGDefs=function(){if(!util._commonSVGDefs){util._commonSVGDefs=util.genSVGElement("defs",util.getCommonSVG())}return util._commonSVGDefs};util.genSVGLinearGradient=function(parent,dir,id){var gradientAttr={x1:"0%",y1:"0%",x2:"0%",y2:"0%"};if(dir){var full={north:"y2",east:"x1",south:"y1",west:"x2"};gradientAttr[full[dir]]="100%"}if(id){gradientAttr.id=id}var linearGradient=util.genSVGElement("linearGradient",parent,gradientAttr);var stop1=util.genSVGElement("stop",linearGradient,{"stop-color":"white",offset:"0%"});var stop2=util.genSVGElement("stop",linearGradient,{"stop-color":"black",offset:"100%"});return linearGradient};util._defaultCanvas=null;util.getDefaultCanvas=function(){if(!util._defaultCanvas){util._defaultCanvas=util._genDefaultCanvas()}return util._defaultCanvas};util._genDefaultCanvas=function(){var w=200,h=200;var canvas=util.genCanvas(w,h);var ctx=canvas.getContext("2d");var imageData=ctx.createImageData(w,h);var D=imageData.data;var base=10;var disp=base*.4;var row,col,idx,val,rowIntensity,intensity;for(row=0;row<h;row++){rowIntensity=10+Math.floor(Math.random()*base);for(col=0;col<w;col++){idx=4*w*row+4*col;intensity=Math.floor(rowIntensity-disp+2*disp*Math.random());D[idx++]=intensity;D[idx++]=intensity+5;D[idx++]=intensity+10;D[idx]=255}}ctx.putImageData(imageData,0,0);return canvas};util.saverMethod=function(method){var lastArguments=[];return function(){var i,changed=false;if(arguments.length!=lastArguments.length){lastArguments=[]}for(i=0;i<arguments.length;i++){if(arguments[i]!==lastArguments[i]){lastArguments[i]=arguments[i];changed=true}}if(changed){method.apply(this,arguments)}}};var wl={};wl.Whenable=function(){this._emitted=false;this._listeners=[];this._result=[]};wl.Whenable.prototype.emit=function(){if(!this._emitted){this._emitted=true;for(var i=0;i<arguments.length;i++){this._result.push(arguments[i])}var listener;while(listener=this._listeners.pop()){impl.async(listener[0],listener[1],this._result)}}};wl.Whenable.prototype.getSubscriber=function(){var me=this;return function(listener,ctx){me._whenEmitted(listener,ctx)}};wl.Whenable.prototype._whenEmitted=function(func,ctx){if(this._emitted){impl.async(func,ctx,this._result)}else{this._listeners.push([func,ctx||null])}};wl.whenAll=function(){if(arguments.length==1){return arguments[0]}else{var whenAll=new wl.Whenable;var whenFirst=arguments[0];var rest=[].slice.call(arguments,1);var whenRest=wl.whenAll.apply(null,rest);whenFirst(function(){whenRest(function(){whenAll.emit()})});return whenAll.getSubscriber()}};var Animator=function(setter){this._setter=setter;this._current=0;this._target=null;this._delta=null;this._animTimeout=null};Animator.prototype.jump=function(val){if(this._animTimeout){var c=this._current,t=this._target,v=val;if(t>c&&v>t||t<c&&v<t){this._delta*=(v-c)/(t-c);this._target=val}else if(t>c&&v<c||t<c&&v>c){this._clearTimeout();this._applyValue(val)}else{this._target=val}}else{this._applyValue(val)}};Animator.prototype.slide=function(val){this._target=val;if(this._target!=this._current){this._delta=(this._target-this._current)*cfg.animationDelay/cfg.animationTime}if(!this._animTimeout){this._tick()}};Animator.prototype._tick=function(){if(Math.abs(this._target-this._current)<Math.abs(this._delta)){if(this._animTimeout){this._clearTimeout()}this._applyValue(this._target)}else{var me=this;this._animTimeout=setTimeout(function(){me._tick()},cfg.animationDelay);this._applyValue(this._current+this._delta)}};Animator.prototype._applyValue=function(value){this._current=value;this._setter(value)};Animator.prototype._clearTimeout=function(){clearTimeout(this._animTimeout);this._animTimeout=null};var imgCache={};var CachedImg=function(url){if(typeof imgCache[url]!="undefined"){return imgCache[url]}else{imgCache[url]=this;this._url=url;this._touchTimeout=null;this._ready=new wl.Whenable;this.whenReady=this._ready.getSubscriber();this._sides={};this._data={};this._SVGImage=null;this._SVGImageId=null;this._download()}};CachedImg.prototype._download=function(){if(!this._url){this._init(null);this._ready.emit()}else{this._img=elemSample.img.cloneNode(false);this._img.src=this._url;this._img.style.display="none";var me=this;this._img.addEventListener("load",function(){me._img.parentNode.removeChild(me._img);me._init(me._img);me._ready.emit()},false);this._img.addEventListener("error",function(){me._img.parentNode.removeChild(me._img);me._init(null);me._ready.emit()},false);document.body.appendChild(this._img)}};CachedImg.prototype.getSide=function(dir){if(typeof this._sides[dir]=="undefined"){this._sides[dir]=this._rotate(this._sides.north,dir)}return this._sides[dir]};var SVGImageCounter=0;CachedImg.prototype.getSVGImageId=function(){if(!this._SVGImage){this._SVGImageId="SVG-Image-"+SVGImageCounter++ +"-"+UQ;var canvas=this._sides.north;var url=util.getCanvasDataURL(canvas);var defs=util.getCommonSVGDefs();this._SVGImage=util.genSVGElement("image",defs,{id:this._SVGImageId,x:"0",y:"0",width:util.px(canvas.width),height:util.px(canvas.height),preserveAspectRatio:"none"});this._SVGImage.setAttributeNS(util._xlinkNS,"xlink:href",url[0])}return this._SVGImageId};CachedImg.prototype.touchSVGImage=function(){if(IS_IE&&this._SVGImage){if(this._touchTimeout){clearTimeout(this._touchTimeout)}var me=this;this._touchTimeout=setTimeout(function(){me._touch()},10)}};CachedImg.prototype._touch=function(){this._SVGImage.setAttribute("height",util.px(this._data.stretchedSize))};CachedImg.prototype.getData=function(){return this._data};CachedImg.prototype._init=function(image){var original=this._genImageCanvas(image);var stretched=this._stretch(original);this._sides.north=stretched.canvas;this._data=this._genData(stretched.canvas);this._data.points=stretched.points;this._data.origSize=original.height};CachedImg.prototype._genImageCanvas=function(image){var result;if(image){result=util.img2canvas(image)}else{result=util.getDefaultCanvas()}return result};CachedImg.prototype._stretch=function(canvas){var w=canvas.width;var h=canvas.height;var data1=canvas.getContext("2d").getImageData(0,0,w,h);var h2=h*68/35;var h2floor=Math.floor(h2);var stretchedCanvas=util.genCanvas(w,h2floor);var ctx2=stretchedCanvas.getContext("2d");var data2=ctx2.createImageData(w,h2floor);var D1=data1.data;var D2=data2.data;var ro;var y2;var y1;var y1_floor;var y2_norm;var y2_norm_2;var y1_norm;var rate0;var rate1;var row=w*4;var idx1;var idx2;var col;var ch;var points=[];var _15_68=15/68;var _12_17=12/17;var _45_68=45/68;var _24_17=24/17;for(y2=0;y2<h2floor;y2++){y2_norm=y2/h2;y2_norm_2=y2_norm*y2_norm;ro=_45_68*y2_norm_2-_24_17*y2_norm+1;y1_norm=_15_68*y2_norm_2*y2_norm-_12_17*y2_norm_2+y2_norm;y1=y1_norm*h2;y1_floor=Math.floor(y1);points[y1_floor]=y2;rate0=Math.min(ro,y1_floor+1-y1);rate1=ro-rate0;idx1=row*y1_floor;idx2=row*y2;for(col=0;col<w;col++){for(ch=0;ch<4;ch++){D2[idx2+ch]=Math.round((rate0*D1[idx1+ch]+rate1*(D1[idx1+ch+row]||0))/ro)}idx1+=4;idx2+=4}}ctx2.putImageData(data2,0,0);return{canvas:stretchedCanvas,points:points}};CachedImg.prototype._rotate=function(north,dir){var w=north.width;var h=north.height;var rotated;if(util.isVertical[dir]){rotated=util.genCanvas(w,h)}else{rotated=util.genCanvas(h,w)}var ctx=rotated.getContext("2d");switch(dir){case"east":ctx.rotate(Math.PI/2);ctx.drawImage(north,0,-h);break;case"south":ctx.rotate(Math.PI);ctx.drawImage(north,-w,-h);break;case"west":ctx.rotate(-Math.PI/2);ctx.drawImage(north,-w,0);break}return rotated};CachedImg.prototype._genData=function(canvas){var w=canvas.width;var h=canvas.height;var maxIntensity=0;var curSize=h;for(var i=1;i<cfg.blocksNumber;i++){curSize/=4;maxIntensity+=Math.floor(curSize)}var virtualNum=1+Math.ceil(Math.log(1/h)/Math.log(1/4));var virtualSize=0;curSize=h;for(i=1;i<virtualNum;i++){curSize/=4;virtualSize+=Math.floor(curSize)}return{stretchedSize:h,sideSize:w,maxIntensity:maxIntensity,virtualPow:1-Math.pow(1/4,virtualNum-1),virtualSize3:virtualSize*3}};var Resizer=function(elem,isBody,listener){this._elem=elem;this._isBody=isBody;this._listener=listener;if(this._isBody){window.addEventListener("resize",this._listener,false);if(document.readyState=="complete"){this._listener()}else{window.addEventListener("load",this._listener,false)}}else{this._detector=elemSample.object.cloneNode(false);util.setStyle(this._detector,{display:"block",position:"absolute",top:"0px",left:"0px",height:"100%",width:"100%",overflow:"hidden",pointerEvents:"none",zIndex:-2048});var me=this;this._detector.onload=function(){this.contentDocument.defaultView.addEventListener("resize",me._listener,false);me._listener()};this._detector.type="text/html";if(IS_IE){this._elem.appendChild(this._detector);this._detector.data="about:blank"}else{this._detector.data="about:blank";this._elem.appendChild(this._detector)}}};Resizer.prototype.destroy=function(){if(this._isBody){window.removeEventListener("resize",this._listener,false)}else{this._elem.removeChild(this._detector)}};var Intence=function(elem){this._destroyed=false;this._elem=elem;this._isBody=this._elem.nodeName.toLowerCase()=="body";this._cmp={};this._sideReady={};this._images={};this._indicators={};this._totals={};this._sizes={};this._addendum={};this._lastOrigCoord={};this._createElemStructure();var rect=this._cmp.scroller.getBoundingClientRect();var scrollWidth=this._cmp.scroller.scrollWidth;var scrollHeight=this._cmp.scroller.scrollHeight;var i,dir;for(i=0;i<util.dir.length;i++){dir=util.dir[i];this._indicators[dir]=null;this._sideReady[dir]=false;this._addendum[dir]=0;this._lastOrigCoord[dir]=0;this._totals[dir]=util.isVertical[dir]?scrollHeight:scrollWidth;this._sizes[dir]=util.isVertical[dir]?rect.height:rect.width}this._loadImages()};Intence.prototype.getElem=function(){return this._elem};Intence.prototype._createElemStructure=function(){this._createElements();this._createResizer();this._createSides()};Intence.prototype._createElements=function(){this._cmp.wrapper=elemSample.div.cloneNode(false);this._cmp.contextor=elemSample.div.cloneNode(false);this._cmp.scroller=elemSample.div.cloneNode(false);this._cmp.pusher=elemSample.div.cloneNode(false);this._cmp.container=elemSample.div.cloneNode(false);var style={elem:{overflow:"hidden",padding:"0px"},wrapper:{position:"relative",overflow:"hidden",width:"100%",height:"100%"},contextor:{position:"absolute",overflow:"hidden",width:"100%",height:"100%"},scroller:{position:"absolute",overflow:"scroll",zIndex:0},container:{}};this._origStyle={overflow:this._elem.style.overflow};if(this._isBody){var margins=["margin","marginTop","marginRight","marginBottom","marginLeft"];var cs=window.getComputedStyle(this._elem,null);var i,m;for(i=0;i<margins.length;i++){m=margins[i];style.container[m]=cs[m];this._origStyle[m]=this._elem.style[m]}style.elem.margin=0}util.setStyle(this._elem,style.elem);util.setStyle(this._cmp.wrapper,style.wrapper);util.setStyle(this._cmp.contextor,style.contextor);util.setStyle(this._cmp.scroller,style.scroller);impl.floatLeft(this._cmp.pusher);util.setStyle(this._cmp.container,style.container);impl.stackingContext(this._cmp.contextor);var id=this._elem.getAttribute("id");if(id){this._cmp.scroller.setAttribute("id",id+"-scroller")}util.attachChildren(this._cmp.container,util.detachChildren(this._elem));this._cmp.pusher.appendChild(this._cmp.container);this._cmp.scroller.appendChild(this._cmp.pusher);this._cmp.contextor.appendChild(this._cmp.scroller);this._cmp.wrapper.appendChild(this._cmp.contextor);this._elem.appendChild(this._cmp.wrapper)};Intence.prototype._createResizer=function(){var me=this;var listener=function(){me._setGeometry();me._indicate()};this._resizer=new Resizer(this._cmp.wrapper,this._isBody,listener)};Intence.prototype._createSides=function(){this._sides={};var order=["west","east","south","north"];var dir;for(var i=0;i<order.length;i++){dir=order[i];this._sides[dir]=createSideElement(dir);this._cmp.contextor.appendChild(this._sides[dir])}};Intence.prototype._restoreElemStructure=function(){this._resizer.destroy();var children=util.detachChildren(this._cmp.container);util.detachChildren(this._elem);for(var prop in this._origStyle){if(this._origStyle.hasOwnProperty(prop)){this._elem.style[prop]=this._origStyle[prop]}}util.attachChildren(this._elem,children)};Intence.prototype._setGeometry=function(){var geom=this._cmp.wrapper.getBoundingClientRect();util.setStyle(this._cmp.pusher,{width:util.px(Math.ceil(geom.width)),height:util.px(Math.ceil(geom.height))})};Intence.prototype._loadImages=function(){var me=this;var sideInitialized={};var defaultUrl=this._elem.getAttribute("scrollimg")||"";var img,dir,url;for(var i=0;i<util.dir.length;i++){dir=util.dir[i];url=this._elem.getAttribute("scrollimg"+dir);img=new CachedImg(url||defaultUrl);sideInitialized[dir]=new wl.Whenable;img.whenReady(function(dir,img){return function(){if(!me._destroyed){me._indicators[dir]=new Indicator(dir,me._cmp.contextor,me._sides[dir],img);me._sideReady[dir]=true;sideInitialized[dir].emit()}}}(dir,img));this._images[dir]=img}wl.whenAll(sideInitialized.north.getSubscriber(),sideInitialized.east.getSubscriber(),sideInitialized.south.getSubscriber(),sideInitialized.west.getSubscriber())(function(){me._indicate(true)});this._cmp.scroller.addEventListener("scroll",function(){me._indicate()},false)};Intence.prototype._indicate=function(init){var geom=this._cmp.wrapper.getBoundingClientRect();var scrollInfo=this._getScrollInfo();var beyond=this._getBeyond(geom,scrollInfo);var infinite=this._getInfinite();for(var i=0;i<util.dir.length;i++){var dir=util.dir[i];if(this._sideReady[dir]){var indicator=this._indicators[dir];var data=this._images[dir].getData();var sizesChanged=this._haveSizesChanged(dir,geom);var totalsChanged=this._haveTotalsChanged(dir,scrollInfo);var origCoord=this._getOrigCoord(dir,beyond,data.origSize,totalsChanged||sizesChanged);var areaSize=util.isVertical[dir]?geom.height:geom.width;var intensity=this._getIntensity(beyond[dir],infinite[dir],data.maxIntensity,areaSize);var sideOffset=beyond[util.isVertical[dir]?"west":"north"];if(dir=="north"||dir=="east"){sideOffset=-sideOffset}indicator.update(geom.width,geom.height,data.points[origCoord],sideOffset,intensity,totalsChanged,init)}}};Intence.prototype._getScrollInfo=function(){var scroller=this._cmp.scroller;return{width:scroller.scrollWidth,height:scroller.scrollHeight,top:scroller.scrollTop,left:scroller.scrollLeft}};Intence.prototype._getBeyond=function(geom,scroll){return{north:this._fixCoord(scroll.top),south:this._fixCoord(scroll.height-scroll.top-geom.height),west:this._fixCoord(scroll.left),east:this._fixCoord(scroll.width-scroll.left-geom.width)}};Intence.prototype._fixCoord=function(val){return Math.max(0,Math.floor(val))};Intence.prototype._getOrigCoord=function(dir,beyond,size,keep){var origPoint=beyond[dir];var result=this._mod(origPoint,size);if(keep){var diff=result-this._lastOrigCoord[dir];this._addendum[dir]-=diff;this._addendum[dir]=this._addendum[dir]%size}this._lastOrigCoord[dir]=result;result+=this._addendum[dir];result=this._mod(result,size);return result};Intence.prototype._getInfinite=function(){var result={},dir,i;for(i=0;i<util.dir.length;i++){dir=util.dir[i];result[dir]=this._elem.getAttribute("scrollinfinite"+dir)!==null}return result};Intence.prototype._haveSizesChanged=function(dir,geom){var changed=false;var newSize=util.isVertical[dir]?geom.height:geom.width;if(this._sizes[dir]!=newSize){changed=true;this._sizes[dir]=newSize}return changed};Intence.prototype._haveTotalsChanged=function(dir,scroll){var changed=false;var el=this._cmp.scroller;var newTotal=util.isVertical[dir]?scroll.height:scroll.width;if(this._totals[dir]!=newTotal){changed=true;this._totals[dir]=newTotal}return changed};Intence.prototype._mod=function(value,module){value=value%module;value+=module;value=value%module;if(value==module){value=0}return value};Intence.prototype._getIntensity=function(beyond,infinite,maxSize,areaSize){var intensity=infinite?1:1-1/(beyond*cfg.indicatorGain+1);var max=Math.min(maxSize,cfg.indicatorMaxArea*areaSize);var pad=1;var size=pad+Math.ceil(intensity*(max-pad));return size};Intence.prototype.destroy=function(){this._restoreElemStructure();this._destroyed=true};var Indicator=function(dir,parent,side,image){var geom=parent.getBoundingClientRect();this._offsets=[];this._offset=0;this._parentWidth=geom.width;this._parentHeight=geom.height;this._scrollAmount=0;this._shown=0;this._coordinates=[];this._sizes=[];this._intensity=0;this._image=image;this._data=image.getData();this._container=new Container(dir,parent,side,image,this._parentWidth,this._parentHeight);this._setParentGeometry=util.saverMethod(this._setParentGeometry);this._setScrollAmount=util.saverMethod(this._setScrollAmount);this._updateIntensity=util.saverMethod(this._updateIntensity);this._setOffset=util.saverMethod(this._setOffset);var me=this;var update=function(val){me._updateIntensity(val,me._parentWidth,me._parentHeight)};this._intensityAnimator=new Animator(update)};Indicator.prototype.update=function(width,height,amount,offset,intensity,animate,init){this._image.touchSVGImage();this._setParentGeometry(width,height);this._setScrollAmount(amount);this._setOffset(offset);if(init){this._intensityAnimator.jump(0);this._intensityAnimator.slide(intensity)}else if(animate){this._intensityAnimator.slide(intensity)}else{this._intensityAnimator.jump(intensity)}};Indicator.prototype._setParentGeometry=function(width,height){this._parentWidth=width;this._parentHeight=height;this._container.updateParentGeometry(width,height)};Indicator.prototype._setScrollAmount=function(amount){this._scrollAmount=amount;this._recalculateCoordinates();this._updateBlocks()};Indicator.prototype._setOffset=function(offset){this._offset=offset;this._updateOffset()};Indicator.prototype._recalculateCoordinates=function(){var d=this._data;var F=this._scrollAmount/d.stretchedSize;var size=d.virtualSize3/(d.virtualPow+3*F);var realOffset=size*F;var total=0;this._sizes=[];var firstSize=size;for(var i=0;i<cfg.blocksNumber;i++){this._sizes.unshift(size);total+=size;size/=4}this._coordinates=[];var coord=Math.round(d.maxIntensity-total+firstSize-realOffset);for(i=0;i<cfg.blocksNumber;i++){this._coordinates.push(coord);coord+=this._sizes[i]}};Indicator.prototype._updateIntensity=function(intensity,parentWidth,parentHeight){this._intensity=intensity;this._container.updateIntensity(intensity,parentWidth,parentHeight);this._updateBlocks()};Indicator.prototype._calculateShown=function(size){var shown=cfg.blocksNumber;for(var i=0;i<cfg.blocksNumber;i++){if(this._coordinates[i]>size){shown=i;break}}return shown};Indicator.prototype._updateOffset=function(){for(var i=0;i<this._shown;i++){if(this._offsets[i]!=this._offset){this._offsets[i]=this._offset;this._container.updateOffset(i,this._offset,this._parentWidth,this._parentHeight)}}};Indicator.prototype._updateBlocks=function(){this._updateShown();this._container.startBlocksUpdate();for(var i=0;i<this._shown;i++){this._updateBlock(i)}this._container.endBlocksUpdate()};Indicator.prototype._updateShown=function(){var i,oldShown=this._shown;this._shown=this._calculateShown(this._intensity);if(this._shown>oldShown){for(i=oldShown;i<this._shown;i++){this._updateBlock(i);this._container.showBlock(i)}}else if(this._shown<oldShown){for(i=this._shown;i<oldShown;i++){this._container.hideBlock(i)}}};Indicator.prototype._updateBlock=function(blockNum){this._container.updateBlockGeometry(blockNum,this._coordinates[blockNum],this._sizes[blockNum],this._intensity,this._parentWidth,this._parentHeight);this._container.updateOffset(blockNum,this._offset,this._parentWidth,this._parentHeight)};var createSideElement=function(dir){var side=elemSample.div.cloneNode(false);var vertical=util.isVertical[dir];var style={pointerEvents:"none",display:"inline",position:"absolute",overflow:"hidden",width:"0px",height:"0px",top:"0px",left:"0px",zIndex:"0"};switch(dir){case"north":style.top="-1px";break;case"east":case"south":break;case"west":style.left="-1px";break}util.setStyle(side,style);return side};var updateSideIntensity=function(side,dir,intensity,width,height){var style={};if(util.isVertical[dir]){style.height=util.px(intensity)}else{style.width=util.px(intensity)}var fullsize=util.isVertical[dir]?height:width;var backcoord=fullsize-intensity;switch(dir){case"west":case"north":break;case"east":style.left=util.px(backcoord+2);break;case"south":style.top=util.px(backcoord+2);break}util.setStyle(side,style)};var Container_div=function(dir,parent,side,image,width,height){this._dir=dir;this._isVertical=util.isVertical[dir];this._parent=parent;this._side=side;this._image=image;this._blocks=[];impl.gradientMask(this._side,this._dir);this._createBlocks()};Container_div.prototype._createBlocks=function(){var canvas=this._image.getSide(this._dir);var style={position:"absolute",display:"none"};if(this._isVertical){style.width="100%"}else{style.height="100%"}var block;for(var i=0;i<cfg.blocksNumber;i++){block=elemSample.div.cloneNode(false);util.setStyle(block,style);impl.backgroundCanvas(block,canvas);this._side.appendChild(block);this._blocks.push(block)}};Container_div.prototype.showBlock=function(blockNum){this._blocks[blockNum].style.display="block"};Container_div.prototype.hideBlock=function(blockNum){this._blocks[blockNum].style.display="none"};Container_div.prototype.updateIntensity=function(intensity,width,height){updateSideIntensity(this._side,this._dir,intensity,width,height)};Container_div.prototype.updateOffset=function(blockNum,offset,width,height){if(this._dir=="south"||this._dir=="west"){offset=-offset}offset-=1;var position;if(this._isVertical){position=util.px(offset)+" 0px"}else{position="0px "+util.px(offset)}this._blocks[blockNum].style.backgroundPosition=position};Container_div.prototype.updateParentGeometry=function(width,height){var style={};if(this._isVertical){
style.width=util.px(width+2)}else{style.height=util.px(height+2)}util.setStyle(this._side,style)};Container_div.prototype.updateBlockGeometry=function(blockNum,coordinate,size,intensity,parentWidth,parentHeight){if(this._dir=="south"||this._dir=="east"){coordinate=intensity-size-coordinate}var sideSize=this._image.getData().sideSize;var style;if(this._isVertical){style={top:util.px(coordinate),height:util.px(size),backgroundSize:util.px(sideSize)+" "+util.px(size)}}else{style={left:util.px(coordinate),width:util.px(size),backgroundSize:util.px(size)+" "+util.px(sideSize)}}util.setStyle(this._blocks[blockNum],style)};Container_div.prototype.startBlocksUpdate=function(){};Container_div.prototype.endBlocksUpdate=function(){};var createSVGTemplate=function(){var svg=util.genSVGElement("svg");var defs=util.genSVGElement("defs",svg);var linearGradient=util.genSVGLinearGradient(defs,null,null);var mask=util.genSVGElement("mask",defs,{x:"0",y:"0",width:"100%",height:"100%"});var rectWidth="0";var rectHeight="0";var maskRect=util.genSVGElement("rect",mask,{x:"0",y:"0",width:"0",height:"0"});var g=util.genSVGElement("g",svg);var patterns=[];var uses=[];var rects=[];for(var i=0;i<cfg.blocksNumber;i++){patterns[i]=util.genSVGElement("pattern",defs,{x:"0",y:"0",width:"0px",height:"0px",patternUnits:"userSpaceOnUse"});uses[i]=util.genSVGElement("use",patterns[i]);rects[i]=util.genSVGElement("rect",g,{x:"0px",y:"0px"})}util.setStyle(svg,{position:"absolute",top:"0px",left:"0px",width:"0px",height:"0px"});return svg};if(METHODS.blocks=="svg"){var svgBlocksTemplate=createSVGTemplate()}var Container_svg=function(dir,parent,side,image,width,height){this._dir=dir;this._isVertical=util.isVertical[dir];this._parent=parent;this._side=side;this._image=image;this._blockcount=Container_svg._svgBlockCounter++;this._svg=null;this._maskRect=null;this._defs=null;this._g=null;this._patterns=null;this._uses=null;this._rects=null;this._setMask();this._createBlocks(width,height)};Container_svg._svgBlockCounter=0;Container_svg.prototype._setMask=function(){var gradientId="svg-gradient-"+this._blockcount+"-"+UQ;var maskId="svg-mask-"+this._blockcount+"-"+UQ;var svg=svgBlocksTemplate.cloneNode(true);var full={north:"y2",east:"x1",south:"y1",west:"x2"};var defs=svg.childNodes[0];var linearGradient=defs.childNodes[0];linearGradient.setAttribute("id",gradientId);linearGradient.setAttribute(full[this._dir],"100%");var mask=defs.childNodes[1];mask.setAttribute("id",maskId);var rectWidth=this._isVertical?"100%":0;var rectHeight=this._isVertical?0:"100%";var maskRect=mask.childNodes[0];util.setAttributes(maskRect,{width:rectWidth,height:rectHeight,style:"stroke: none; fill: url(#"+gradientId+")"});var g=svg.childNodes[1];g.setAttribute("style","mask:url(#"+maskId+");");util.setStyle(svg,{position:"absolute",top:"0px",left:"0px",width:util.px(rectWidth),height:util.px(rectHeight)});this._side.appendChild(svg);this._svg=svg;this._defs=defs;this._maskRect=maskRect;this._g=g};Container_svg.prototype._createBlocks=function(width,height){var canvas=this._image.getSide(this._dir);var blocksetId="svg-blockset-"+this._blockcount+"-"+UQ;var patternWidth=this._isVertical?canvas.width:0;var patternHeight=this._isVertical?0:canvas.height;var rectWidth=this._isVertical?width:0;var rectHeight=this._isVertical?0:height;var imageId=this._image.getSVGImageId();this._patterns=[];this._uses=[];this._rects=[];var patternId,useId,rectId;for(var i=0;i<cfg.blocksNumber;i++){patternId="pattern-"+i+"-"+blocksetId;this._patterns[i]=this._defs.childNodes[i+2];util.setAttributes(this._patterns[i],{id:patternId,width:util.px(patternWidth),height:util.px(patternHeight)});useId="use-"+i+"-"+blocksetId;this._uses[i]=this._patterns[i].childNodes[0];this._uses[i].setAttribute("id",useId);this._uses[i].setAttributeNS(util._xlinkNS,"xlink:href","#"+imageId);rectId="rect-"+i+"-"+blocksetId;this._rects[i]=this._g.childNodes[i];util.setAttributes(this._rects[i],{id:rectId,width:util.px(rectWidth),height:util.px(rectHeight),style:"fill: url(#"+patternId+");"});this._uses[i].setAttribute("transform","matrix(1 0 0 1 0 0)")}};Container_svg.prototype.showBlock=function(blockNum){};Container_svg.prototype.hideBlock=function(blockNum){var wh={};if(util.isVertical[this._dir]){wh.height="0px"}else{wh.width="0px"}util.setAttributes(this._rects[blockNum],wh)};Container_svg.prototype.updateIntensity=function(intensity,width,height){updateSideIntensity(this._side,this._dir,intensity,width,height);var wh={};if(this._isVertical){wh.height=util.px(intensity)}else{wh.width=util.px(intensity)}util.setStyle(this._svg,wh);util.setAttributes(this._svg,wh);util.setAttributes(this._maskRect,wh)};Container_svg.prototype.updateOffset=function(blockNum,offset,width,height){if(this._dir=="south"||this._dir=="west"){offset=-offset}var sideSize=this._image.getData().sideSize;var offsetPx=util.px(offset%sideSize);var attr={};attr[this._isVertical?"x":"y"]=offsetPx;util.setAttributes(this._patterns[blockNum],attr)};Container_svg.prototype.updateParentGeometry=function(width,height){var wh={};if(this._isVertical){wh.width=util.px(width+2)}else{wh.height=util.px(height+2)}util.setStyle(this._side,wh);util.setStyle(this._svg,wh);util.setAttributes(this._svg,wh);for(var i=0;i<cfg.blocksNumber;i++){util.setAttributes(this._rects[i],wh)}};Container_svg.prototype.updateBlockGeometry=function(blockNum,coordinate,size,intensity,parentWidth,parentHeight){if(this._dir=="south"||this._dir=="east"){coordinate=intensity-size-coordinate}var scaleSize=size/this._image.getData().stretchedSize;var wh;if(this._isVertical){wh={y:util.px(coordinate),height:util.px(size)}}else{wh={x:util.px(coordinate),width:util.px(size)}}util.setAttributes(this._rects[blockNum],wh);util.setAttributes(this._patterns[blockNum],wh);var data=this._image.getData();var transform=this._uses[blockNum].transform.baseVal.getItem(0);var angle=0;var moveX=0;var moveY=0;switch(this._dir){case"east":angle=90;moveX=data.stretchedSize;break;case"south":angle=180;moveX=data.sideSize;moveY=data.stretchedSize;break;case"west":angle=270;moveY=data.sideSize;break}var scaleX=1;var scaleY=1;if(this._isVertical){scaleY=scaleSize}else{scaleX=scaleSize}var matrix=util.getCommonSVG().createSVGMatrix().scaleNonUniform(scaleX,scaleY).translate(moveX,moveY).rotate(angle);transform.setMatrix(matrix)};Container_svg.prototype.startBlocksUpdate=function(){this._side.style.display="none"};Container_svg.prototype.endBlocksUpdate=function(){this._side.style.display="block"};var Container_webkitTransform=function(dir,parent,side,image,width,height){this._dir=dir;this._isVertical=util.isVertical[dir];this._parent=parent;this._side=side;this._image=image;this._canvas=image.getSide("north");this._blocks=[];this._setMask();this._createBlocks()};Container_webkitTransform.prototype._setMask=function(){var style={WebkitTransformOrigin:"0 0"};switch(this._dir){case"north":style.top="-1px";style.left="-1px";break;case"east":style.top="-1px";style.left="1px";break;case"south":style.top="1px";style.left="1px";break;case"west":style.top="-1px";style.left="-1px";break}util.setStyle(this._side,style);impl.gradientMask(this._side,"north")};Container_webkitTransform.prototype._createBlocks=function(){var canvas=this._image.getSide("north");var style={position:"absolute",width:"100%"};var block,blocks=[];for(var i=0;i<cfg.blocksNumber;i++){block=elemSample.div.cloneNode(false);util.setStyle(block,style);impl.backgroundCanvas(block,canvas);this._side.appendChild(block);this._blocks.push(block)}};Container_webkitTransform.prototype.showBlock=function(blockNum){this._blocks[blockNum].style.display="block"};Container_webkitTransform.prototype.hideBlock=function(blockNum){this._blocks[blockNum].style.display="none"};Container_webkitTransform.prototype.updateIntensity=function(intensity,width,height){this._side.style.height=util.px(intensity)};Container_webkitTransform.prototype.updateOffset=function(blockNum,offset,width,height){var sideSize=this._image.getData().sideSize;switch(this._dir){case"north":case"east":offset-=1;break;case"south":offset+=width-sideSize;offset+=1;break;case"west":offset+=height-sideSize;offset+=1;break}this._blocks[blockNum].style.backgroundPosition=util.px(offset)+" 1px"};Container_webkitTransform.prototype.updateParentGeometry=function(width,height){var rotate="";var translate="";switch(this._dir){case"north":break;case"east":rotate="rotate(90deg)";translate="translate("+width+"px,0px)";break;case"south":rotate="rotate(180deg)";translate="translate("+width+"px,"+height+"px)";break;case"west":rotate="rotate(270deg)";translate="translate(0px,"+height+"px)";break}var style={width:util.px((this._isVertical?width:height)+2),WebkitTransform:[translate,rotate].join(" ")};util.setStyle(this._side,style)};Container_webkitTransform.prototype.updateBlockGeometry=function(blockNum,coordinate,size,intensity,parentWidth,parentHeight){var sideSize=this._image.getData().sideSize;var pad=2;util.setStyle(this._blocks[blockNum],{top:util.px(coordinate),height:util.px(size+pad),backgroundSize:util.px(sideSize)+" "+util.px(size)})};Container_webkitTransform.prototype.startBlocksUpdate=function(){};Container_webkitTransform.prototype.endBlocksUpdate=function(){};var Container;switch(METHODS.blocks){case"svg":Container=Container_svg;break;case"div":Container=Container_div;break;case"webkitTransform":Container=Container_webkitTransform;break}var intences=[];var destroyUnintenced=function(){var elem;for(var i=0;i<intences.length;i++){elem=intences[i].getElem();if(!impl.hasClass(elem,"intence")){intences[i].destroy();elem.intence=null;delete elem.intence;intences.splice(i,1);i--}}};var createIntenced=function(){var elems=document.getElementsByClassName("intence");for(var i=0;i<elems.length;i++){if(!elems[i].intence){intences.push(new Intence(elems[i]));elems[i].intence=true}}};var reset=function(){if(INTENCE_ENABLED){destroyUnintenced();createIntenced()}};if(document.readyState=="complete"){reset()}else{window.addEventListener("load",reset,false)}exports.reset=reset;exports.enabled=INTENCE_ENABLED});